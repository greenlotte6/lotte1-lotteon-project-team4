<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.lotteon.dao.OrderMapper">

    <!-- 주문 상세 보기 -->
    <select id="orderTotal" resultType="kr.co.lotteon.dto.OrdersDTO">
        SELECT
        p.img_file_1 AS img_file_1,
        p.pid,
        p.pname,
        p.company,
        p.price,
        p.discount,
        p.delivery_free,
        oi.quantity,
        o.order_total,
        o.oid,
        o.payment,
        o.order_status,
        o.recipient,
        u.uname,
        u.hp,
        u.addr1,
        u.addr2,
        SUM(oi.quantity * p.price) AS total_price,
        SUM(p.discount * oi.quantity) AS total_discount,
        SUM(p.delivery_free) AS total_delivery_free,
        SUM(oi.quantity * p.price + p.delivery_free - p.discount * oi.quantity) AS total_pay
        FROM orders o
        JOIN Users u ON o.Users_uid = u.uid
        JOIN order_item oi ON oi.order_oid = o.oid
        JOIN Products p ON p.pid = o.Products_pid
        WHERE o.oid = #{oid}
        GROUP BY o.oid
    </select>

    <!-- 사용자 주문 목록 조회 -->
    <select id="selectOrderViewsByUid" resultType="kr.co.lotteon.dto.OrderViewDTO">
        SELECT
        o.oid,
        DATE_FORMAT(o.order_date, '%Y-%m-%d') AS orderDate,
        o.shipping_status AS shippingStatus,
        p.pname AS productName,
        p.price AS productPrice,
        oi.quantity,
        IFNULL(s.company, '판매자 없음') AS sellerCompany,
        IFNULL(s.ceo, '정보 없음') AS sellerCeo
        FROM orders o
        JOIN order_item oi ON o.oid = oi.order_oid
        JOIN Products p ON oi.products_pid = p.pid
        LEFT JOIN seller s ON p.company = s.company
        WHERE o.Users_uid = 1
        ORDER BY o.order_date DESC;
    </select>


</mapper>
